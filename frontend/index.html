<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- VueJS framework -->
  <script src="https://unpkg.com/vue"></script>
  <!-- Buefy framework -->
  <link rel="stylesheet" href="https://unpkg.com/buefy/dist/buefy.min.css">
  <script src="https://unpkg.com/buefy/dist/buefy.min.js"></script>
  <!-- Axios framework -->
  <script src="https://cdn.jsdelivr.net/npm/axios@0.24.0/dist/axios.min.js"></script>
</head>

<body>
  <div id="app">
    <!-- Buefy components goes here -->
    <div class="container">
      <section class="section">
        <h1 class="title is-1">VMCS Simulator</h1>
        <div class="field is-horizontal">
          <div class="field-label is-normal">
            <label class="label">Machine Power</label>
          </div>
          <div class="field-body">
            <div class="field">
              <b-switch v-model="isSwitchedOn" true-value="On" false-value="Off">
                {{ isSwitchedOn }}
              </b-switch>
            </div>
          </div>
        </div>
        <b-collapse class="panel is-dark" animation="slide" :open=true>
          <template #trigger>
            <div class="panel-heading" role="button">
              <b>Customer Panel</b>
            </div>
          </template>
          <div class="panel-block">
            <div class="container is-fluid">
              <p>{{ wsData }}</p>
            </div>
          </div>
          <div class="panel-block">
            <div class="container is-fluid">
              <h3 class="title has-text-centered">Insert Coins</h3>
            </div>
          </div>
          <div class="panel-block">
            <div class="columns container is-centered">
              <template v-for="(coin, index) in coins">
                <div class="column is-narrow">
                  <button v-if="coin.country === 'SG'" v-on:click="insertCoin(coin)" class="button is-info">{{ coin.name
                    }}</button>
                  <button v-if="coin.country === 'BN'" v-on:click="insertCoin(coin)" class="button is-danger">{{
                    coin.name
                    }}</button>
                </div>
              </template>
            </div>
          </div>
          <div class="panel-block">
            <div class="columns is-centered">
              <template v-for="(drink, index) in drinks" :key="i">
                <div class="column is-narrow">
                  <div class="card">
                    <div class="card-content">
                      <p class="title">
                        {{ drink.name }}
                      </p>
                      <p class="subtitle">
                        {{ '$' + Number(drink.price).toFixed(2) }}
                      </p>
                    </div>
                    <footer class="card-footer">
                      <p class="card-footer-item">
                        <span>
                          <b-button :disabled="drink.quantity == 0" type="is-fullwidth is-rounded is-primary">Buy</b-button>
                        </span>
                      </p>
                    </footer>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </b-collapse>
        <b-collapse class="panel is-warning" animation="slide" :open=false>
          <template #trigger>
            <div class="panel-heading" role="button">
              <b>Maintainer Panel</b>
            </div>
          </template>
          <div class="panel-block">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. <br />
            Nulla accumsan, metus ultrices eleifend gravida, nulla nunc varius lectus, nec rutrum justo nibh eu lectus.
            <br />
            Ut vulputate semper dui. Fusce erat odio, sollicitudin vel erat vel, interdum mattis neque.
          </div>
        </b-collapse>
        <b-collapse class="panel is-danger" animation="slide" :open=false>
          <template #trigger>
            <div class="panel-heading" role="button">
              <b>Machinery Panel</b>
            </div>
          </template>
          <div class="panel-block">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. <br />
            Nulla accumsan, metus ultrices eleifend gravida, nulla nunc varius lectus, nec rutrum justo nibh eu lectus.
            <br />
            Ut vulputate semper dui. Fusce erat odio, sollicitudin vel erat vel, interdum mattis neque.
          </div>
        </b-collapse>
      </section>
    </div>
  </div>
  <script>
    const SERVER_HOST = 'localhost:8080';

    new Vue({
      el: '#app',
      computed: {

      },
      data() {
        return {
          sessionId: null,
          wsData: null,
          isSwitchedOn: "Off",
          drinks: [],
          coins: Object.freeze([
            {
              name: "S$0.05",
              country: "SG",
              value: 5
            },
            {
              name: "S$0.10",
              country: "SG",
              value: 10
            },
            {
              name: "S$0.20",
              country: "SG",
              value: 20
            },
            {
              name: "S$0.50",
              country: "SG",
              value: 50
            },
            {
              name: "S$1.00",
              country: "SG",
              value: 100
            },
            {
              name: "B$1.00",
              country: "BN",
              value: 100
            },
          ])
        }
      },
      mounted() {
        this.initWebSocket();
        this.getDrinksList();
      },
      methods: {
        getDrinksList() {
          axios.get(`//${SERVER_HOST}/drinks`)
            .then(response => {
              // console.log(response);
              this.drinks = response.data.drinks;
            })
            .catch(error => {
              console.log(error);
            });
        },
        initWebSocket() {
          let connection = new WebSocket(`ws://${SERVER_HOST}/websocket/${this.sessionId ?? ''}`);
          connection.onmessage = (event) => {
            console.log("[WebSocket] Incoming data:", event.data);
            this.wsData = event.data;
          }
        },
        insertCoin(coinData) {
          // console.log("Coin inserted!", JSON.stringify(coinData));

          const requestUrl = `//${SERVER_HOST}/coins/insert`;
          if (this.sessionId) {
            requestUrl += `?sessionId=${this.sessionId}`;
          }

          axios.post(requestUrl, coinData)
            .then((response) => {
              this.sessionId = response.data.sessionId;
              // console.log(response);
            })
            .catch((error) => {
              console.log(error);
            });
        }
      }
    })
  </script>
</body>

</html>